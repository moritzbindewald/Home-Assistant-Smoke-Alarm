blueprint:
  name: Rauchmelder Alarm ðŸ”¥ (Universell + Testmodus + Wiederholungsalarm + Raumerkennung + Manueller Alarm)
  description: >
    ðŸš¨ VollstÃ¤ndig konfigurierbare Rauchmelder-Alarmautomation fÃ¼r Home Assistant  

    **Features:**  
    ðŸ”¹ Basisalarm: Lichter, Rollos, Sirenen / TTS  
    ðŸ”¹ Friendly Names fÃ¼r Rauchmelder  
    ðŸ”¹ Raumerkennung / Sensorraum-Mapping  
    ðŸ”¹ Testmodus: EinzelentitÃ¤t, Volltest, alle Rauchmelder  
    ðŸ”¹ trigger_all_sensors: alle Rauchmelder gleichzeitig auslÃ¶sen  
    ðŸ”¹ Manueller Alarm / Trigger flexibel fÃ¼r verschiedene Rauchmelder  
    ðŸ”¹ NutzerbestÃ¤tigung: echter Alarm vs Falschalarm  
    ðŸ”¹ Falschalarm-RÃ¼cksetzung inkl. Farbe / Helligkeit  
    ðŸ”¹ Monitoring wÃ¤hrend Alarm  
    ðŸ”¹ PrÃ¤senzabhÃ¤ngige Aktionen & Anzeige  
    ðŸ”¹ Flexible TTS-Nachrichten  
    ðŸ”¹ Alarmdauer, Wartezeit, Timeout  
    ðŸ”¹ Wiederholungsalarm / Reminder  
    ðŸ”¹ Flexible Stummschaltung / Buzzer-Option  
    ðŸ”¹ UI in ausklappbaren Sektionen

  domain: automation

  input:
    # --- Sektion 1: Rauchmelder ---
    smoke_sensors:
      name: Rauchmelder *
      description: Liste der zu Ã¼berwachenden Rauchmelder (mindestens einer)
      selector:
        entity:
          domain: binary_sensor
          device_class: smoke
          multiple: true

    smoke_sensor_friendly_names:
      name: Friendly Names fÃ¼r Rauchmelder
      description: Optional: Friendly Names fÃ¼r die einzelnen Rauchmelder
      default: {}
      selector:
        object: {}

    smoke_sensor_rooms:
      name: RÃ¤ume fÃ¼r Rauchmelder
      description: Optional: Rauchmelder bestimmten RÃ¤umen zuordnen
      default: {}
      selector:
        object: {}

    # --- Sektion 2: AlarmgerÃ¤te ---
    lights:
      name: ðŸ’¡ Lichter
      description: Lichter, die bei Alarm aktiviert werden
      default: []
      selector:
        entity:
          domain: light
          multiple: true

    covers:
      name: ðŸªŸ Rollos
      description: Rollos, die bei Alarm geÃ¶ffnet werden
      default: []
      selector:
        entity:
          domain: cover
          multiple: true

    sirens:
      name: ðŸ”Š Sirenen / Lautsprecher
      description: GerÃ¤te, die TÃ¶ne abspielen kÃ¶nnen
      default: []
      selector:
        entity:
          domain: media_player
          multiple: true

    # --- Sektion 3: Benachrichtigung & TTS ---
    tts_message:
      name: ðŸ—£ï¸ TTS Nachricht
      description: Nachricht, die auf Lautsprechern / Alexa abgespielt wird
      default: "Rauchalarm! Bitte prÃ¼fen Sie die Rauchmelder."
      selector:
        text: {}

    notify_target:
      name: ðŸ“© Benachrichtigung
      description: Optional: Push-EmpfÃ¤nger
      default: []
      selector:
        target: {}

    include_home_status_in_notification:
      name: ðŸ  Anwesenheitsstatus anzeigen
      description: Wenn aktiviert, wird angezeigt, wer zuhause ist
      default: true
      selector:
        boolean: {}

    presence_sensors:
      name: ðŸ‘¥ PrÃ¤senzsensoren
      description: Optional: Sensoren fÃ¼r Anwesenheit
      default: []
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    # --- Sektion 4: Dauer & Timeout ---
    duration:
      name: â±ï¸ Alarmdauer (Minuten)
      default: 15
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: Minuten

    wait_timeout:
      name: â³ Wartezeit auf NutzerbestÃ¤tigung (Minuten)
      default: 10
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: Minuten

    continue_on_timeout:
      name: Alarm bei Timeout weiterlaufen lassen
      default: true
      selector:
        boolean: {}

    repeat_alarm:
      name: ðŸ” Wiederholungsalarm
      description: Wenn aktiviert, wird nach Timeout erneut eine Benachrichtigung geschickt
      default: true
      selector:
        boolean: {}

    watch_devices:
      name: Ãœberwachung wÃ¤hrend Alarm
      description: GerÃ¤te, die wÃ¤hrend eines Alarms Ã¼berwacht und ggf. wieder aktiviert werden sollen
      default: []
      selector:
        entity:
          multiple: true

    # --- Sektion 5: Mute / Buzzer ---
    mute_device:
      name: ðŸ”• GerÃ¤t zum Stummschalten
      default: ""
      selector:
        device: {}

    mute_method:
      name: Mute-Methode
      default: "select_option"
      selector:
        select:
          options:
            - "select_option"
            - "turn_off"
            - "service_call"

    # --- Sektion 6: Testmodus ---
    test_mode:
      name: ðŸ§ª Testmodus
      default: "aus"
      selector:
        select:
          options:
            - "aus"
            - "nur_benachrichtigung"
            - "nur_lichter"
            - "nur_rollos"
            - "nur_sirenen"
            - "einzelentitaet"
            - "alle_rauchmelder"
            - "volltest"

    test_entity:
      name: EinzelentitÃ¤t testen
      default: ""
      selector:
        entity:
          multiple: false

    trigger_all_sensors:
      name: Alle Rauchmelder auslÃ¶sen
      default: false
      selector:
        boolean: {}

    # --- Sektion 7: Manueller Alarm ---
    manual_trigger_entity:
      name: GerÃ¤t/EntitÃ¤t fÃ¼r manuellen Alarm
      description: Optional: GerÃ¤t/EntitÃ¤t, um Alarm manuell auszulÃ¶sen
      default: ""
      selector:
        entity:
          multiple: false

    manual_trigger_mode:
      name: Manueller Alarm-Modus
      description: Wie soll der manuelle Alarm ausgelÃ¶st werden (z.â€¯B. select_option, turn_on, service_call)
      default: "select_option"
      selector:
        select:
          options:
            - "select_option"
            - "turn_on"
            - "service_call"

trigger:
  - platform: state
    entity_id: !input smoke_sensors
    to: "on"

condition: []

action:
  - variables:
      smoke_names: !input smoke_sensor_friendly_names
      smoke_rooms: !input smoke_sensor_rooms
      persons_home: >
        {% set ph = states.person | selectattr('state','eq','home') | map(attribute='name') | list %}
        {{ ph }}
      sensors_active: >
        {% set sa = states | selectattr('entity_id','in', presence_sensors) | selectattr('state','eq','on') | list %}
        {{ sa }}
      someone_home: "{{ (persons_home | length > 0) or (sensors_active | length > 0) }}"
      monitored_devices: !input watch_devices
      alarm_active: true
      notified: false
      lights_prev_state: >
        {% set states_dict = {} %}
        {% for l in lights %}
          {% set states_dict = states_dict | combine({l: states(l)}) %}
        {% endfor %}
        {{ states_dict }}
      covers_prev_state: >
        {% set states_dict = {} %}
        {% for c in covers %}
          {% set states_dict = states_dict | combine({c: states(c)}) %}
        {% endfor %}
        {{ states_dict }}

  # --- Testmodus ---
  - choose:
      - conditions: "{{ test_mode != 'aus' }}"
        sequence:
          - variables:
              sensors_to_trigger: >
                {% if trigger_all_sensors %}
                  {{ smoke_sensors }}
                {% elif test_mode == 'einzelentitaet' and test_entity != '' %}
                  [{{ test_entity }}]
                {% else %}
                  [{{ trigger.entity_id }}]
                {% endif %}
          - repeat:
              for_each: "{{ sensors_to_trigger }}"
              sequence:
                - variables:
                    current_sensor: "{{ repeat.item }}"
                - choose:
                    - conditions: "{{ test_mode in ['nur_benachrichtigung','volltest'] }}"
                      sequence:
                        - service: notify.notify
                          data:
                            message: "ðŸ’¬ Test: {{ smoke_rooms.get(current_sensor,'Unbekannter Raum') }}: {{ smoke_names.get(current_sensor,current_sensor) }}"
                            target: !input notify_target
                    - conditions: "{{ test_mode in ['nur_lichter','volltest'] }}"
                      sequence:
                        - service: light.turn_on
                          target:
                            entity_id: !input lights
                          data:
                            brightness_pct: 100
                    - conditions: "{{ test_mode in ['nur_rollos','volltest'] }}"
                      sequence:
                        - service: cover.open_cover
                          target:
                            entity_id: !input covers
                    - conditions: "{{ test_mode in ['nur_sirenen','volltest'] }}"
                      sequence:
                        - service: tts.google_translate_say
                          target:
                            entity_id: !input sirens
                          data:
                            message: !input tts_message

  # --- Manueller Alarm ---
  - if:
      - condition: template
        value_template: "{{ manual_trigger_entity != '' }}"
   