blueprint:
  name: Rauchmelder-Alarm mit Best√§tigung & Sirenen-Mute
  description: >
    Rauchmelder-Alarm: √ñffnet Rolll√§den, schaltet Lichter, sendet kritische Push-Benachrichtigung.
    Die Sirene (Buzzer) wird nach Best√§tigung per App stummgeschaltet.
  domain: automation

  input:
    smoke_sensor:
      name: Rauchmelder
      description: Rauchmelder, der den Alarm ausl√∂st.
      selector:
        entity:
          domain: binary_sensor
          device_class: smoke

    buzzer_select:
      name: Rauchmelder-Buzzer (Select)
      description: Die Select-Entit√§t f√ºr die Sirene/Buzzer ("mute" Option).
      selector:
        entity:
          domain: select

    all_covers:
      name: Alle Rolll√§den √∂ffnen
      selector:
        boolean: {}
      default: false

    target_covers:
      name: Ziel-Rolll√§den (nur ausf√ºllen, wenn "Alle Rolll√§den" aus)
      selector:
        target:
          entity:
            domain: cover
      default: []

    all_lights:
      name: Alle Lichter einschalten
      selector:
        boolean: {}
      default: false

    target_lights:
      name: Ziel-Lichter (nur ausf√ºllen, wenn "Alle Lichter" aus)
      selector:
        target:
          entity:
            domain: light
      default: []

    notify_devices:
      name: Mobilger√§te f√ºr Push-Nachricht
      selector:
        device:
          integration: mobile_app
          multiple: true

variables:
  action_ack: "ACKNOWLEDGE_ALARM"

trigger:
  - platform: state
    entity_id: !input smoke_sensor
    to: "on"

action:
  - choose:
      - conditions:
          - condition: state
            entity_id: !input smoke_sensor
            state: "on"
        sequence:
          # Rolll√§den √∂ffnen (alle oder ausgew√§hlte)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ !input all_covers }}"
                sequence:
                  - service: cover.open_cover
                    target:
                      entity_id: all
              - default:
                  - service: cover.open_cover
                    target: !input target_covers

          # Lichter einschalten (alle oder ausgew√§hlte)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ !input all_lights }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: all
                    
                      brightness_pct: 100
              - default:
                  - service: light.turn_on
                    target: !input target_lights
                    
                      brightness_pct: 100

          # Push an ausgew√§hlte Ger√§te mit Best√§tigungs-Button
          - repeat:
              for_each: !input notify_devices
              sequence:
                - service: notify.mobile_app_{{ repeat.item }}
                  
                    title: "üö® Rauchmelder Alarm!"
                    message: >
                      Alarm ausgel√∂st um {{ now().strftime('%H:%M:%S') }} Uhr
                      vom Ger√§t: {{ state_attr(!input smoke_sensor, 'friendly_name') }}.
                    
                      critical: 1
                      sound: "alarm.caf"
                      actions:
                        - action: "{{ action_ack }}"
                          title: "Alarm best√§tigen"
                          destructive: true
                          authenticationRequired: true

          # Auf Best√§tigung warten
          - wait_for_trigger:
              - platform: event
                event_type: mobile_app_notification_action
                event_
                  action: "{{ action_ack }}"
            timeout: 3600
            continue_on_timeout: false

          # Buzzer/Sirene muten
          - service: select.select_option
            target:
              entity_id: !input buzzer_select
            
              option: "mute"

          # Feedback an alle mobilen Ger√§te
          - repeat:
              for_each: !input notify_devices
              sequence:
                - service: notify.mobile_app_{{ repeat.item }}
                  
                    message: "Rauchmelder-Sirene deaktiviert (Best√§tigung erhalten)."

mode: single
