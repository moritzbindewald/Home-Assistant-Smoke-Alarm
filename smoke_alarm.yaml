blueprint:
  name: "Feueralarm Full Dashboard + Auto Buzzer üî•"
  description: >
    Vollst√§ndiger Feueralarm-Blueprint mit automatischer Buzzer-Steuerung.
    Testmodus stumm, Normalalarm laut, Fehlalarm aus.
  domain: automation
  input:
    # Rauchmelder üåê
    smoke_detectors:
      name: "üåê Rauchmelder"
      description: "Alle zu √ºberwachenden Rauchmelder"
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    # Lichter / Szenen üí°
    alarm_lights:
      name: "üö® Alarm-Lichter"
      selector:
        entity:
          domain: light
          multiple: true
    escape_lights:
      name: "üü¢ Fluchtweg-Lichter"
      selector:
        entity:
          domain: light
          multiple: true
    emergency_lights:
      name: "‚ö™ Notfall-Lichter"
      selector:
        entity:
          domain: light
          multiple: true

    # TTS üó£Ô∏è
    tts_speakers:
      name: "üó£Ô∏è TTS-Speaker"
      selector:
        entity:
          domain: media_player
          multiple: true

    # Konfigurierbare Entit√§ten ‚öôÔ∏è
    custom_entities:
      name: "‚öôÔ∏è Rollos, Steckdosen, Smart Locks"
      selector:
        entity:
          multiple: true

    # Push / Notfallkontakte üì≤
    push_service:
      name: "üì≤ Push-Service"
      selector:
        action:
    residents_group:
      name: "üë™ Bewohner"
      selector:
        entity:
          domain: group
    emergency_contacts:
      name: "üÜò Notfallkontakte"
      selector:
        entity:
          domain: group

    # Notfallmodus / Testmodus üèÉ‚Äç‚ôÇÔ∏èüß™
    emergency_button:
      name: "üèÉ‚Äç‚ôÇÔ∏è Notfallmodus"
      selector:
        entity:
          domain: input_boolean
    test_mode:
      name: "üß™ Testmodus aktiv"
      selector:
        boolean: {}
    test_mode_duration:
      name: "‚è±Ô∏è Testmodus Dauer"
      default: "00:00:30"
      selector:
        duration: {}
    test_mode_full_program:
      name: "‚ö° Testmodus Vollprogramm"
      default: true
      selector:
        boolean: {}

    # Eskalation ‚ö†Ô∏è
    escalation_delay:
      name: "‚è≥ Zeit bis Eskalation"
      default: "00:02:00"
      selector:
        duration: {}

    # Logging & Dashboard üìä
    logbook_entity:
      name: "üìì Logbuch"
      selector:
        entity:
          domain: input_text
    dashboard_entity:
      name: "üìä Dashboard"
      selector:
        entity:
          domain: input_text

trigger:
  - platform: state
    entity_id: !input smoke_detectors
    to: "on"
  - platform: state
    entity_id: !input emergency_button
    to: "on"
  - platform: state
    entity_id: !input test_mode
    to: "on"

condition: []

action:
  # -----------------------------
  # Testmodus
  # -----------------------------
  - choose:
      - conditions:
          - "{{ is_state(test_mode,'on') }}"
        sequence:
          - service: select.select_option
            target:
              entity_id: !input smoke_detectors
            data:
              option: "buzzer_mute"
          - service: light.turn_on
            target:
              entity_id:
                - !input alarm_lights
                - !input escape_lights
                - !input emergency_lights
          - service: tts.google_say
            target:
              entity_id: !input tts_speakers
            data:
              message: "Testmodus aktiviert"
          - service: !input push_service
            data:
              message: "Testmodus aktiv"
          - choose:
              - conditions: "{{ test_mode_full_program }}"
                sequence:
                  - service: cover.open_cover
                    target:
                      entity_id: !input custom_entities
          - delay: !input test_mode_duration
          - service: light.turn_off
            target:
              entity_id:
                - !input alarm_lights
                - !input escape_lights
                - !input emergency_lights
          - service: tts.google_say
            target:
              entity_id: !input tts_speakers
            data:
              message: "Testmodus beendet"

  # -----------------------------
  # Notfallmodus manuell
  # -----------------------------
      - conditions:
          - "{{ trigger.entity_id == !input emergency_button }}"
        sequence:
          - service: select.select_option
            target:
              entity_id: !input smoke_detectors
            data:
              option: "buzzer_alarm"
          - service: light.turn_on
            target:
              entity_id:
                - !input alarm_lights
                - !input escape_lights
                - !input emergency_lights
          - service: tts.google_say
            target:
              entity_id: !input tts_speakers
            data:
              message: "Notfallmodus aktiviert!"
          - service: !input push_service
            data:
              message: "Notfallmodus aktiviert"
          - service: cover.open_cover
            target:
              entity_id: !input custom_entities

  # -----------------------------
  # Normaler Alarm durch Rauchmelder
  # -----------------------------
      - conditions: []
        sequence:
          - service: select.select_option
            target:
              entity_id: !input smoke_detectors
            data:
              option: "buzzer_alarm"
          - choose:
              - conditions: "{{ states('persons') | selectattr('state','eq','home') | list | length > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id:
                        - !input alarm_lights
                        - !input escape_lights
                        - !input emergency_lights
                  - service: tts.google_say
                    target:
                      entity_id: !input tts_speakers
                    data:
                      message: "Feueralarm! Bitte beachten Sie die Sicherheitsma√ünahmen."
                  - service: !input push_service
                    data:
                      message: "Alarm aktiv üö®"
                  - service: cover.open_cover
                    target:
                      entity_id: !input custom_entities
              - conditions: []
                sequence:
                  - service: !input push_service
                    data:
                      message: "Feueralarm ausgel√∂st, niemand zu Hause"
          - delay: !input escalation_delay
          - service: !input push_service
            data:
              message: "Eskalation: Alarm weiterhin aktiv"

  # -----------------------------
  # Fehlalarm / Notfall best√§tigt
  # -----------------------------
      - conditions:
          - "{{ trigger.entity_id in [] }}" # Intern gesteuert durch Automation/Buttons
        sequence:
          - choose:
              - conditions: "{{ false }}"  # nur interne Logik
                sequence: []

mode: single