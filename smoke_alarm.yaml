blueprint:
  name: "Feueralarm Full Dashboard + Auto Buzzer ğŸ”¥"
  description: >
    VollstÃ¤ndiger Feueralarm-Blueprint mit automatischer Buzzer-Steuerung.
    Testmodus stumm, Normalalarm laut, Fehlalarm aus.
  domain: automation
  input:
    # Rauchmelder ğŸŒ
    smoke_detectors:
      name: "ğŸŒ Rauchmelder"
      description: "Alle zu Ã¼berwachenden Rauchmelder"
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    # Lichter / Szenen ğŸ’¡
    alarm_lights:
      name: "ğŸš¨ Alarm-Lichter"
      selector:
        entity:
          domain: light
          multiple: true
    escape_lights:
      name: "ğŸŸ¢ Fluchtweg-Lichter"
      selector:
        entity:
          domain: light
          multiple: true
    emergency_lights:
      name: "âšª Notfall-Lichter"
      selector:
        entity:
          domain: light
          multiple: true

    # TTS ğŸ—£ï¸
    tts_speakers:
      name: "ğŸ—£ï¸ TTS-Speaker"
      selector:
        entity:
          domain: media_player
          multiple: true

    # Konfigurierbare EntitÃ¤ten âš™ï¸
    custom_entities:
      name: "âš™ï¸ Rollos, Steckdosen, Smart Locks"
      selector:
        entity:
          multiple: true

    # Push / Notfallkontakte ğŸ“²
    push_service:
      name: "ğŸ“² Push-Service"
      selector:
        action:
    residents_group:
      name: "ğŸ‘ª Bewohner"
      selector:
        entity:
          domain: group
    emergency_contacts:
      name: "ğŸ†˜ Notfallkontakte"
      selector:
        entity:
          domain: group

    # Notfallmodus / Testmodus ğŸƒâ€â™‚ï¸ğŸ§ª
    emergency_button:
      name: "ğŸƒâ€â™‚ï¸ Notfallmodus"
      selector:
        entity:
          domain: input_boolean
    test_mode:
      name: "ğŸ§ª Testmodus aktiv"
      selector:
        boolean: {}
    test_mode_duration:
      name: "â±ï¸ Testmodus Dauer"
      default: "00:00:30"
      selector:
        duration: {}
    test_mode_full_program:
      name: "âš¡ Testmodus Vollprogramm"
      default: true
      selector:
        boolean: {}

    # Eskalation âš ï¸
    escalation_delay:
      name: "â³ Zeit bis Eskalation"
      default: "00:02:00"
      selector:
        duration: {}

    # Logging & Dashboard ğŸ“Š
    logbook_entity:
      name: "ğŸ““ Logbuch"
      selector:
        entity:
          domain: input_text
    dashboard_entity:
      name: "ğŸ“Š Dashboard"
      selector:
        entity:
          domain: input_text

    # Alarmmodus ğŸš¨ğŸ†˜âŒ
    alarm_mode:
      name: "ğŸš¨ Alarmmodus"
      default: "Kein Alarm âœ…"
      selector:
        select:
          options:
            - "Kein Alarm âœ…"
            - "Alarm aktiv ğŸš¨"
            - "Notfall bestÃ¤tigt ğŸ†˜"
            - "Fehlalarm âŒ"

trigger:
  - platform: state
    entity_id: !input smoke_detectors
    to: "on"
  - platform: state
    entity_id: !input emergency_button
    to: "on"
  - platform: state
    entity_id: !input test_mode
    to: "on"
  - platform: state
    entity_id: !input alarm_mode

condition: []

action:
  # -----------------------------
  # Testmodus
  # -----------------------------
  - choose:
      - conditions:
          - "{{ is_state(test_mode,'on') }}"
        sequence:
          - service: select.select_option
            target:
              entity_id: !input smoke_detectors
            data:
              option: "buzzer_mute"
          - service: light.turn_on
            target:
              entity_id:
                - !input alarm_lights
                - !input escape_lights
                - !input emergency_lights
          - service: tts.google_say
            target:
              entity_id: !input tts_speakers
            data:
              message: "Testmodus aktiviert"
          - service: !input push_service
            data:
              message: "Testmodus aktiv"
          - choose:
              - conditions: "{{ test_mode_full_program }}"
                sequence:
                  - service: cover.open_cover
                    target:
                      entity_id: !input custom_entities
          - delay: !input test_mode_duration
          - service: light.turn_off
            target:
              entity_id:
                - !input alarm_lights
                - !input escape_lights
                - !input emergency_lights
          - service: tts.google_say
            target:
              entity_id: !input tts_speakers
            data:
              message: "Testmodus beendet"

  # -----------------------------
  # Notfallmodus manuell
  # -----------------------------
      - conditions:
          - "{{ trigger.entity_id == !input emergency_button }}"
        sequence:
          - service: select.select_option
            target:
              entity_id: !input smoke_detectors
            data:
              option: "buzzer_alarm"
          - service: light.turn_on
            target:
              entity_id:
                - !input alarm_lights
                - !input escape_lights
                - !input emergency_lights
          - service: tts.google_say
            target:
              entity_id: !input tts_speakers
            data:
              message: "Notfallmodus aktiviert!"
          - service: !input push_service
            data:
              message: "Notfallmodus aktiviert"
          - service: cover.open_cover
            target:
              entity_id: !input custom_entities

  # -----------------------------
  # Normaler Alarm durch Rauchmelder
  # -----------------------------
      - conditions: []
        sequence:
          - service: select.select_option
            target:
              entity_id: !input smoke_detectors
            data:
              option: "buzzer_alarm"
          - choose:
              - conditions: "{{ states('persons') | selectattr('state','eq','home') | list | length > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id:
                        - !input alarm_lights
                        - !input escape_lights
                        - !input emergency_lights
                  - service: tts.google_say
                    target:
                      entity_id: !input tts_speakers
                    data:
                      message: "Feueralarm! Bitte beachten Sie die SicherheitsmaÃŸnahmen."
                  - service: !input push_service
                    data:
                      message: "Alarm aktiv ğŸš¨"
                  - service: cover.open_cover
                    target:
                      entity_id: !input custom_entities
              - conditions: []
                sequence:
                  - service: !input push_service
                    data:
                      message: "Feueralarm ausgelÃ¶st, niemand zu Hause"
          - delay: !input escalation_delay
          - service: !input push_service
            data:
              message: "Eskalation: Alarm weiterhin aktiv"

  # -----------------------------
  # Fehlalarm / Notfall bestÃ¤tigt
  # -----------------------------
      - conditions:
          - "{{ states(alarm_mode) in ['Fehlalarm âŒ','Notfall bestÃ¤tigt ğŸ†˜'] }}"
        sequence:
          - choose:
              - conditions: "{{ states(alarm_mode) == 'Fehlalarm âŒ' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: !input smoke_detectors
                    data:
                      option: "buzzer_mute"
                  - service: light.turn_off
                    target:
                      entity_id:
                        - !input alarm_lights
                        - !input escape_lights
                        - !input emergency_lights
                  - service: tts.google_say
                    target:
                      entity_id: !input tts_speakers
                    data:
                      message: "Fehlalarm aufgehoben"
                  - service: !input push_service
                    data:
                      message: "Fehlalarm âŒ"
              - conditions: "{{ states(alarm_mode) == 'Notfall bestÃ¤tigt ğŸ†˜' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: !input smoke_detectors
                    data:
                      option: "buzzer_alarm"
                  - service: light.turn_on
                    target:
                      entity_id:
                        - !input alarm_lights
                        - !input escape_lights
                        - !input emergency_lights
                  - service: tts.google_say
                    target:
                      entity_id: !input tts_speakers
                    data:
                      message: "Notfall bestÃ¤tigt ğŸ†˜"
                  - service: !input push_service
                    data:
                      message: "Notfall bestÃ¤tigt ğŸ†˜"

mode: single